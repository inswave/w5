/*! w5 2014-07-14 */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery","underscore","Backbone","exports"],function(c,d,e,f){a.w5=b(c,d,e,a,f)}):a.w5=b(a.jQuery||a.$,a._,a.Backbone,a,{})}(this,function(a,b,c,d,e){"use strict";function f(a,d,e,f,g){this.option=new c.Model(this.optionDefaultObject),this.colModel=d,this.view=e,this.collection=f,this.colLinker={},this.colInvertLinker=[],this.table=new this.MetaModel({id:"table"},{rowCID:"*",colID:"*"}),this.column=new c.Collection(null,{model:this.MetaModel}),this.row=new c.Collection(null,{model:this.MetaModel}),this.cell=new c.Collection(null,{model:this.MetaModel}),this.groupInfo={grouped:!0,groupRowCIDs:[]},b(d).each(function(a,b){var c=a.id||a.headerLabel;if(!c)throw new Error("The column should be assigned one of id or headerLable.");this.colLinker[c]=b,this.colInvertLinker[b]=c},this),a.colOrder||(a.colOrder=this.colInvertLinker.slice()),this.option.set(a),b(d).each(function(a,c){b.chain(a).each(function(a,b){"id"!==b&&this.setMeta(["*",c],b,a,{inorder:!0})},this)},this),b.each(g||[],function(a){this.setMeta([a[0],a[1]],"style",a[2])},this)}function g(a,b){return new g.fn.init(a,b)}var h=function(){var a=[];return setInterval(function(){b(a).each(function(a){a.checkResize()})},200),{add:function(b){b.wrapper_width=b.$el.width(),a.push(b)}}}(),i=function(a){if(null===a)return"null";if(a&&(1===a.nodeType||9===a.nodeType))return"element";var b=Object.prototype.toString.call(a),c=b.match(/\[object (.*?)\]/)[1].toLowerCase();if("number"===c){if(isNaN(a))return"nan";if(!isFinite(a))return"infinity"}return c};b.each(["Null","Undefined","Object","Array","String","Number","Boolean","Function","RegExp","Element","NaN","Infinite"],function(a){i["is"+a]=function(b){return i(b)===a.toLowerCase()}}),b.extend(f.prototype,{optionDefaultObject:{scrollLeft:0,scrollTop:0,frozenColumn:0,rowNum:10},metaDefaultObject:{width:100,headerLabel:"",readonly:!1,disabled:!1,displayType:"text",options:null,hidden:!1,dataType:null,format:"","class":""},metaDataTypes:{style:"object",option:"object","class":"className",disabled:!0,readOnly:!0,displayType:!0,options:!0},MetaModel:c.Model.extend({initialize:function(a,b){this.rowCID=b.rowCID,this.colID=b.colID,this.type="*"===this.rowCID&&"*"===this.colID?"table":"*"===this.rowCID?"column":"*"===this.colID?"row":"cell"}}),getModel:function(a,b,c){var d,e,f;return"*"===a&&"*"===b?this.table:("*"===a?(e=b,d=this.column):"*"===b?(e=a,d=this.row):(e=a+","+b,d=this.cell),f=d.get(e)||null,!f&&c&&(f=new this.MetaModel({id:e},{rowCID:a,colID:b}),d.push(f)),f)},setData:function(a,c,d){var f,g,h,i;if(d=d||{},this.collection.__validator&&b.isUndefined(d.validate)&&(d.validate=!0),a[1]=this.getColID(a[1],d.inorder),"*"===a[0]&&"*"===a[1])f=this.collection.reset(c,d);else if("*"===a[1]){c=this.checkDataType(c);for(h in c)i=this.getMeta([a[0],h],"dataType"),i&&(c[h]=e.dataType[i](c[h]));f=this.collection.at(a[0]).set(c,d)}else"*"===a[0]?(d.save=!1,d.targetColumn=a[1],this.collection.find(function(f,h){if(!(b(c).isArray()&&h>=c.length)){var j=b(c).isArray()?c[h]:c;return i=this.getMeta([h,a[1]],"dataType"),i&&(j=e.dataType[i](j)),g=f.set(a[1],j,d),g===!1}},this)):(i=this.getMeta([a[0],a[1]],"dataType"),i&&(c=e.dataType[i](c)),f=this.collection.at(a[0]).set(a[1],c,d));d.save===!0&&this.save(f,d)},runExpression:function(a,b,c){return a.call(this.view,{rowIndex:b,colId:c,attributes:this.collection.at(b).toJSON()})},getCellData:function(a,c){var d=this.getMeta([a,c],"expression");return b.isFunction(d)?(d=this.runExpression(d,a,c),b.isFunction(d)?(this.setMeta([a,c],"expression",d,{silent:!0}),this.runExpression(d,a,c)):d):b.isString(d)&&this.evalExpression?this.evalExpression(a,c,d):this.collection.at(a).get(c)},getData:function(a,c){c=c||{};var d,e,f,g=c.type&&"array"===c.type.toLowerCase();return a[1]=this.getColID(a[1],c.inorder),"*"===a[1]?(d="*"!==a[0],e=d?[this.collection.at(a[0])]:this.collection.models,f=b.map(e,function(a){var d,e;return d=c.pick===!0||g?this.colInvertLinker:c.pick?b.intersection(this.colInvertLinker,c.pick):c.omit?b.difference(this.colInvertLinker,c.omit):a.keys(),e=b.map(d,function(b){return this.getCellData(a.collection.indexOf(a),b)},this),g?e:b.object(d,e)},this),d?f[0]:f):"*"===a[0]?this.collection.map(function(b,c){return this.getCellData(c,a[1])},this):this.getCellData(a[0],a[1])},getDataLength:function(){return this.collection.length},getDataCID:function(a){return"*"===a||b(a).isString()?a:this.collection.at(a).cid},getMetaIndex:function(a){return this.collection.indexOf(this.collection.get(a))},setMeta:function(a,c,d,e){e=e||{},a[1]=this.getColID(a[1],e.inorder);var f=this.getModel(this.getDataCID(a[0]),a[1],!0),g={uid:b.uniqueId()};e.alter&&f.has(c)&&(g=f.get(c)),g.value="width"===c||"height"===c?parseInt(d,10):d,f.set(c,"id"===c?d:g,e)},getMeta:function(a,c,d){d=d||{},a[0]=this.getDataCID(a[0]),a[1]=this.getColID(a[1],d.inorder);var e,f,g=this.getModel(a[0],a[1]);if("*"===a[0]||"*"===a[1]||d.noncomputed)e=g&&g.has(c)?g.get(c).value:this.metaDefaultObject[c];else switch(f=b([g,this.getModel("*",a[1]),this.getModel(a[0],"*"),this.getModel("*","*")]).compact(),f=b(b.map(f,function(a){return a.get(c)})).compact(),0===f.length&&(f=[{uid:-1,value:this.metaDefaultObject[c]}]),this.metaDataTypes[c]){case"object":f=b(f).sortBy(function(a){return parseInt(a.uid,10)}),e=b(f).reduce(function(a,c){return b.extend(a,c.value)},{});break;case"className":e=b.union(b.pluck(f,"value").join(" ").split(/\s+/)).join(" ");break;default:e=b.max(f,function(a){return parseInt(a.uid,10)}).value}return e},hasMeta:function(a,b,c,d){d=d||{},a[1]=this.getColID(a[1],d.inorder);var e=this.getModel(this.getDataCID(a[0]),a[1]);return!!e&&e.has(b)},removeMeta:function(a,b,c){c=c||{},a[1]=this.getColID(a[1],c.inorder);var d=this.getModel(this.getDataCID(a[0]),a[1]);d&&d.unset(b,c)},removeMetaByDataCID:function(a){var c=this.cell.length,d=b.filter(this.cell.models,function(b){return-1===b.id.indexOf(a)});c>d.length&&this.cell.reset(d,{silent:!0}),this.row.remove(this.row.get(a),{silent:!0})},setOption:function(){return this.option.set.apply(this.option,arguments)},getOption:function(){return this.option.get.apply(this.option,arguments)},getColID:function(a,c){return"*"===a||b(a).isString()?a:b(a).isNumber()?c?this.colInvertLinker[a]:this.visibleCol[a]:null},getColIndex:function(a,c){return"*"===a||b(a).isNumber()?a:b(a).isString()?c?this.colLinker[a]:b(this.visibleCol).indexOf(a):null},updateVisibleCol:function(){var a=this.getOption("colOrder");this.visibleCol=b.reduce(a,function(a,b){return this.getMeta(["*",b],"hidden")||a.push(b),a},[],this)},getVisibleCol:function(){return this.visibleCol},getFrozenArea:function(){return b.reduce(b.range(this.getOption("frozenColumn")),function(a,b){return a+this.getMeta(["*",b],"width")},0,this)},makeJSONfromArray:function(a){var c=b.keys(this.colLinker),d=b.isArray(a[0])?!0:!1;return a=d?b.map(a,function(a){return b.object(c,a)},this):b.object(c,a)},checkDataType:function(a){if(b.isArray(a))i.isObject(a[0])||(a=this.makeJSONfromArray(a));else if(!i.isObject(a))throw new TypeError("Array, JSON data types allow only.");return a},addRow:function(a,c,d){var e;d=d||{},0===arguments.length?c={}:1===arguments.length?b.isNumber(arguments[0])?c={}:(c=this.checkDataType(a),a=null):arguments.length>=2&&(b.isObject(arguments[0])&&(d=c,c=a,a=null),c=this.checkDataType(c)),0===a?e=this.collection.unshift(c):(a&&(d.at=a),e=this.collection.add(c,d)),b.isArray(e)?b.each(e,function(a){a.__isNew=!0}):e.__isNew=!0,d.save===!0&&this.save(e,d)},removeRow:function(a,c){var d;c=c||{},b.isNumber(a)?(d=this.collection.at(a),this.removeMetaByDataCID(d.cid)):b.isString(a)&&(d=this.collection.get(a),this.removeMetaByDataCID(a)),d&&(c.destroy&&(c.url=b.result(d,"url")),d=this.collection.remove(d),b.isArray(d)?(d=b.reduce(d,function(a,b){return b.__isNew||a.push(b),a},[]),Array.prototype.push.apply(this.collection.__removeModels,d)):d.__isNew||this.collection.__removeModels.push(d),c.destroy&&this.destroy(d,c))},sort:function(a,c){b.isUndefined(a)?this.collection.sortInfo.column=[]:b.isFunction(a)?this.collection.sortInfo.column=a:((b.isNumber(a)||b.isString(a))&&(a=[a]),a=b.map(a,function(a){return this.getColID(a)},this),this.collection.sortInfo.column=a),b.isUndefined(c)?this.collection.sortInfo.direction=["asc"]:(b.isString(c)&&(c=[c]),this.collection.sortInfo.direction=c),this.collection.sortData()},fetch:function(a,c){b.isUndefined(a)?a=this.collection:i.isNumber(a)&&(a=this.collection.at(a)),a.fetch(c)},save:function(a,c){var d,e,f=c.success;c=c||{},b.isArray(a)||(d=this.collection.indexOf(a),c.pick||c.omit?(e=this.getData([d,"*"],c),c.patch=!0):e=null,c.success=function(b,d){a.__isNew=!1,f&&f(b,d,c)},this.collection.at(d).save(e,c))},destroy:function(a,c){var d=this,e=c.success;b.isArray(a)||(c.success=function(a,f){b.each(d.collection.__removeModels,function(b,c,d){a.id===b.id&&d.splice(c,1)}),e&&e(a,f,c)},a.destroy(c))},getCUData:function(a){var c={create:[],update:[],"delete":[]},d=a.excludeCreate||!1,e=a.excludeUpdate||!1,f=a.excludeDelete||!1;return d&&e||(c=b.reduce(this.collection.models,function(a,b,c){return!d&&b.__isNew?(b.__idx=c,a.create.push(b)):!e&&b.hasChanged()&&(b.__idx=c,a.update.push(b)),a},c,this)),f||Array.prototype.push.apply(c.delete,this.collection.__removeModels),c},syncData:function(a){var d=this,e=this.getCUData(a||(a={})),f=e.create.slice(),g=b.extend({},c.Events,{url:this.collection.urlCUD,getJSON:function(c){b.each(c,function(b,c,d){d[c]=this.getData([b.__idx,"*"],a),delete b.__idx},d)},toJSON:function(){return this.getJSON(e.create),this.getJSON(e.update),e}}),h=a.success,i=this;return a.success=function(c,d){i.collection.__removeModels=[],b.each(f,function(b,d){b.__isNew=!1,a.afterProcess&&c.create&&c.create[d]&&b.set(c.create[d])}),h&&h(c,d,a)},c.sync("create",g,a)},getGridData:function(){return this.collection}});var j={parse:function(a,c){if(c.saved)a=this.attributes;else if(b.isString(a)&&(a=JSON.parse(a)),this.collection&&b.isArray(a))return this.parseWithDataType(this.collection.keys,a,this.collection.grid?this.collection.grid.options.colModel:null);return a},defaults:function(){return this.collection&&this.collection.defaults?i.isFunction(this.collection.defaults)?this.collection.defaults.call(this):this.collection.defaults:void 0},parseWithDataType:function(a,b,c){for(var d,f={},g=0,h=a.length;h>g;g++)c&&(d=c[g].dataType,d&&(b[g]=e.dataType[d](b[g]))),f[a[g]]=b[g];return f}},k={__validator:null,__invalidCallback:null,__sorting:!1,__filtering:!1,__originalCollection:null,defaults:null,initialize:function(a,b){b&&(this.grid=b.grid,this.keys=b.keys,this.url=b.url,this.urlCUD=b.urlCUD,this.defaults=b.defaults,this.__removeModels=[])},clone:function(){return new this.constructor(this.models,{grid:this.grid,keys:this.keys})},parse:function(a){return b.isString(a)?JSON.parse(a):a},cloneCollection:function(){this.__originalCollection||(this.__originalCollection=this.clone(),this.__originalCollection.listenTo(this,"add remove",this.syncData))},resetCollection:function(a){"filter"===a?this.__sorting?(this.reset(this.__originalCollection.models,{silent:!0}),this.sortData()):(this.reset(this.__originalCollection.models),this.__originalCollection.stopListening(this,"add remove",this.syncData),this.__originalCollection=null):"sort"===a&&(this.__filtering?(this.reset(this.__originalCollection.models,{silent:!0}),this.filterData(!0,{})):(this.reset(this.__originalCollection.models),this.__originalCollection.stopListening(this,"add remove",this.syncData),this.__originalCollection=null))},syncData:function(a,c,d){var e;d.add?(0===d.at?e=this.indexOf(c.at(1)):(e=c.indexOf(a)-1,e=this.indexOf(c.at(e))+1),this.add(a,b.extend(d,{at:e,silent:!0}))):(e=this.indexOf(a),this.remove(a,b.extend(d,{index:e,silent:!0})))},sortInfo:{column:[],direction:[],comparator:function(a,c){if(!this.sortInfo.column)return 0;var d,e=this.sortInfo.column,f=this.sortInfo.direction;if(d=b.find(e,function(b){return a.attributes[b]!==c.attributes[b]}),!d){var g=a.collection.__originalCollection||a.collection,h=g.indexOf(a),i=g.indexOf(c);return h>i?1:-1}return"asc"===(f[b.indexOf(e,d)]||"asc").toLowerCase()?a.attributes[d]>c.attributes[d]?1:-1:a.attributes[d]<c.attributes[d]?1:-1}},sortData:function(){this.sortInfo.column.length>0?(this.cloneCollection(),this.__sorting=!0,this.comparator=b.isFunction(this.sortInfo.column)?this.sortInfo.column:this.sortInfo.comparator,this.sort()):this.__sorting&&(this.__sorting=!1,this.comparator=null,this.resetCollection("sort"))}},l=null,m=null,n={template:b.template("<<%= tagName %> id='<%= id %>' class='gGrid<%= className %>' style='width:<%= width %>'><div class='gGrid-setTable'><div class='w5_grid_editbox' contenteditable='true'></div><table class='gGrid-table' style='width:0'><caption class='gGrid-caption'><%= caption %></caption><colgroup></colgroup><thead></thead><tbody></tbody></table><div class='w5-grid-focused-cell border-top hide'></div><div class='w5-grid-focused-cell border-right hide'></div><div class='w5-grid-focused-cell border-bottom hide'></div><div class='w5-grid-focused-cell border-left hide'></div><div class='adjustCol-handle-hover hide'></div><div class='frozenHandle hide'></div><div class='frozenHandle-move hide'></div><div class='columnMove-start hide'></div><div class='columnMove-move hide'></div><div class='columnMove-indicator hide'><span class='columnMove-indicator-arrow'></span><span class='columnMove-indicator-bar'></span></div><div class='adjustCol-start hide'><span class='adjustCol-start-icon'></span></div><div class='adjustCol-move hide'><span class='adjustCol-move-icon'></span></div><div class='gScroll-v'><button class='scrollHandler'>Move vertical scroll</button></div><div class='gScroll-h'><button class='scrollHandler'>Move horizontal scroll</button></div></div></<%= tagName %>>"),events:{"dblclick .gGrid-table thead":function(a){this.sortColumn.dblClickEvent.call(this,a)},"mousedown .gGrid-table thead":function(a){this.columnMove.downEvent.call(this,a)},"click .gGrid-table tbody":function(a){this.clickCell.clickEvent.call(this,a)},"dblclick .gGrid-table tbody":function(a){this.clickCell.clickEvent.call(this,a)},"mousedown .frozenHandle":function(a){this.frozenColumn.downEvent.call(this,a)},"mousedown .gScroll-v":function(a){this.verticalScroll.areaDownEvent.call(this,a)},"mousedown .gScroll-v .scrollHandler":function(a){this.verticalScroll.handleDownEvent.call(this,a)},"mousedown .gScroll-h":function(a){this.horizontalScroll.areaDownEvent.call(this,a)},"mousedown .gScroll-h .scrollHandler":function(a){this.horizontalScroll.handleDownEvent.call(this,a)},mousewheel:function(a){this.scrollByWheel.wheelEvent.call(this,a)},"keydown .w5_grid_editbox":"handleKeydown","keydown .gGrid-table>tbody":"handleKeydown"},keydownEvents:{38:"moveUp",40:"moveDown",37:"moveLeft",39:"moveRight",13:"focusWidget",113:"focusWidget",27:"blurWidget",9:"moveActionableItem",36:"jumpTo",35:"jumpTo",33:"jumpTo",34:"jumpTo"},initialize:function(a){this.options=a,a.parseTable&&(this.parseTable(a),!this.collection&&a.collection&&(this.collection=a.collection));var d=b.map(a.colModel,function(a){return"headerLabel"in a||(a.headerLabel=a.id),a.id||a.headerLabel}),e=a.defaults||b.object(d,b.pluck(a.colModel,"default"));!this.id&&this.$el&&this.$el.attr("id")&&(this.id=this.$el.attr("id")),a.collection instanceof c.Collection?(b.extend(this.collection.constructor.prototype.model.prototype,j,l),b.extend(this.collection.constructor.prototype,k,m),this.collection.grid=this,this.collection.keys=a.collection.keys?a.collection.keys:d,this.collection.defaults=a.collection.defaults?a.collection.defaults:e):this.collection=new t(a.collection,{grid:this,keys:d,defaults:e,parse:!0}),this.viewModel=new f(a.option,a.colModel,this,this.collection,a.style),a.validator&&this.setValidator(a.validator),b.isFunction(a.invalidCallback)&&this.setInValidCallback(a.invalidCallback),a.fetch&&this.viewModel.fetch(this.collection,b.extend({reset:!0},a.fetch)),this.tabbableElements=["checkbox"],this.listenTo(this.collection,"change",this.onModelChange),this.listenTo(this.collection,"add remove",this.onModelAddRemove),this.listenTo(this.collection,"reset sort",this.onReset),this.listenTo(this.collection,"sync",this.drawWhole),this.listenTo(this.viewModel.table,"change",this.drawMetaByPos),this.listenTo(this.viewModel.column,"change",this.drawMetaByPos),this.listenTo(this.viewModel.row,"change",this.drawMetaByPos),this.listenTo(this.viewModel.cell,"change",this.drawMetaByPos),this.listenTo(this.viewModel.option,"change",this.onOptionChange),this.setGridEvents()},render:function(){var b,c;return this.viewModel.updateVisibleCol(),b=a(this.template({tagName:this.tagName||"div",id:this.id,className:" "+(this.className||""),width:this.viewModel.getOption("width"),caption:this.viewModel.getOption("caption")})),this.$el.replaceWith(b),this.$el=b,c=b.find(".gGrid-setTable"),this.$wrapper_div=c,this.tableWidth=c.width(),this.wholeTblWidth=this.getWholeTblWidth(),this.rowTop=0,this.rowNum=b.find("tbody tr").length,this.startCol=0,this.endCol=b.find("colgroup col").length,this.$scrollYArea=b.find(".gScroll-v"),this.$scrollYHandle=b.find(".gScroll-v .scrollHandler"),this.$scrollXArea=b.find(".gScroll-h"),this.$scrollXHandle=b.find(".gScroll-h .scrollHandler"),this.$editBox=b.find(".w5_grid_editbox"),this.scrollYHandleMinHeight=parseInt(this.$scrollYHandle.css("min-height"),10),this.scrollXHandleMinWidth=parseInt(this.$scrollXHandle.css("min-width"),10),this.addEvents(),this.setResize(),this.headNum=b.find("thead tr").length,this},setGridEvents:function(){var a,b={};for(a in this.options.gridEvents){var c=a.split(" ")[0];b[c]||(b[c]=[]),b[c].push({select:a.slice(c.length+1),funcName:this.options.gridEvents[a]})}this.gridEventMatch=b;for(a in b)"change"!==a&&(this.events[a+" td"]="handleCommonEvent");this.delegateEvents(this.events)},handleCommonEvent:function(c){var d,e,f,g=this.gridEventMatch[c.type]||[],h=a(c.target).closest("td"),i=h.index(),j=h.parent().index()+this.rowTop,k=this.viewModel.getDataCID(j),l=this.viewModel.getOption("frozenColumn");for(i>=l&&(i+=this.startCol),i=this.viewModel.getColID(i,!0),d=0;d<g.length;d++)for(f=this.select(g[d].select),e=0;e<f.length;e++)this.viewModel.getDataCID(f[e][0])===k&&f[e][1]===i&&(b.isString(g[d].funcName)?this.options[g[d].funcName].call(this,c,j,i):b.isFunction(g[d].funcName)&&g[d].funcName.call(this,c,j,i))},parseTable:function(c){if("TABLE"===this.$el[0].tagName){var d,e,f=this.$el.find("tr"),g=a(f[0]),h=[],i=[];f=a(b(f).rest()),b(g.find("td")).each(function(b){var c,d=a(b),e=parseInt(d.attr("colspan"),10)||1;for(h.push(d.width()),i.push(d.text()),c=1;e>c;c++)h.push(0),i.push("")}),c.colModel=b(i).map(function(a,b){return{headerLabel:a,width:h[b]}}),e=b.map(c.colModel,function(a){return a.id||a.headerLabel}),d=b(f).map(function(c){return b(a(c).find("td")).map(function(b){return a(b).text()})}),c.collection=new t(d,{keys:e,parse:!0}),c.style=[],b(f).each(function(d,e){b(a(d).find("td")).each(function(d,f){var g=a(d).attr("style")||"",h=b(g.split(/;+\s*/g)).reduce(function(a,b){var c=b.split(/:/);return 2===c.length&&(a||(a={}),a[c[0]]=c[1]),a},null);h&&c.style.push([c.collection.at(e).cid,i[f],h])})})}},createTbody:function(){var c,d,e,f,g=this.$el.find("tbody"),h=this.$el.find("colgroup"),i=this.viewModel.getOption("rowNum"),j=this.viewModel.getVisibleCol(),k=0,l="";for(this.$el.find("tr").remove(),f=0;f<j.length;f++)if(k+=this.viewModel.getMeta(["*",f],"width"),l+="<col style='width:"+this.viewModel.getMeta(["*",f],"width")+"px'>",k>=this.tableWidth){f++;break}for(i=Math.min(i,this.collection.length),c=0;i>c;c++){for(e=a("<tr class='gGrid-row'>"),d=0;f>d;d++)e.append("<td>");g.append(e)}h.append(l),e=a("<tr>"),b(b.range(f)).each(function(){var b=a("<th class='gGrid-headerLabel' scope='col'><div class='gGrid-headerLabelWrap'></th>");e.append(b)},this),this.$wrapper_div.find("thead").append(e)},addEvents:function(){var a=this;this.$editBox.on("blur",function(b){q.text.endEdit.call(q.text,b,a)}),this.delegateEvents(),h.add(this)},sortColumn:{dblClickEvent:function(b){var c=a(b.target).closest("th"),d=c.index(),e=this.viewModel.getOption("frozenColumn"),f=e>d?d:d+this.startCol-e;this.viewModel.hasMeta(["*",f],"sortable")&&this.sortColumn.sortColumn.call(this,f),a("document").addClass("noselect")},sortColumn:function(a){var c=this.collection.sortInfo.column||[],d=this.collection.sortInfo.direction||[],e=this.viewModel.getColID(a),f=b.indexOf(c,e),g=-1===f?0:"asc"===d[f]?1:2;g=(g+1)%3,0===g?(c.splice(f,1),d.splice(f,1)):-1===f?(c.push(e),d.push(1===g?"asc":"desc")):d[f]=1===g?"asc":"desc",this.sort(c,d)}},columnMove:{draggedColumn:null,_wrapMoveEvent:null,_wrapUpEvent:null,$pickTH:null,$pickTHWidth:null,dragInfo:{startX:null,indicatorMovePosX:null,increasedX:null},_downEvent:function(c){var d,e,f=this.viewModel.getOption("colOrder"),g=this.viewModel.getVisibleCol();this.columnMove.$indicator=this.$el.find(".columnMove-indicator"),this.columnMove.$indicatorStart=this.$el.find(".columnMove-start"),this.columnMove.$indicatorMove=this.$el.find(".columnMove-move"),this.columnMove.$pickTH=a(c.target).closest("th"),this.columnMove.$pickTHWidth=this.columnMove.$pickTH.outerWidth(),this.columnMove.dragInfo.startX=c.clientX,this.columnMove.dragInfo.indicatorMovePosX=this.columnMove.$pickTH.position().left,this.columnMove.$pickTH.length>0&&(d=this.columnMove.$pickTH.index(),e=this.viewModel.getOption("frozenColumn"),this.columnMove.draggedColumn=e>d?d:d+this.startCol-e),f[this.columnMove.draggedColumn]!==g[this.columnMove.draggedColumn]&&(this.columnMove.draggedColumn=b(f).indexOf(this.columnMove.draggedColumn)),a("body").addClass("noselect")},downEvent:function(a){var c;(a.target.className.indexOf("gGrid-headerLabelWrap")>-1||a.target.className.indexOf("gGrid-headerLabelText")>-1||a.target.className.indexOf("w5-grid-sort")>-1)&&"BUTTON"!==a.target.tagName&&(this.columnMove._downEvent.call(this,a),c=this,this.columnMove._wrapMoveEvent=function(a){c.columnMove.moveEvent.call(this,a)},this.columnMove._wrapUpEvent=function(a){c.columnMove.upEvent.call(this,a)},this.columnMove._wrapMoveEvent=b.bind(this.columnMove._wrapMoveEvent,this),this.columnMove._wrapUpEvent=b.bind(this.columnMove._wrapUpEvent,this),document.addEventListener("mousemove",this.columnMove._wrapMoveEvent,!0),document.addEventListener("mouseup",this.columnMove._wrapUpEvent,!0))},_moveEvent:function(c){var d,e,f,g=a(c.target).closest("th"),h=this.viewModel.getOption("colOrder"),i=this.viewModel.getVisibleCol();this.columnMove.$indicatorStart.css({left:this.columnMove.dragInfo.indicatorMovePosX,width:this.columnMove.$pickTH.width()-2}).removeClass("hide"),this.columnMove.$indicatorMove.css({width:this.columnMove.$pickTH.width()}).removeClass("hide"),this.columnMove.dragInfo.increasedX=c.clientX-this.columnMove.dragInfo.startX,this.columnMove.$indicatorMove.css("left",this.columnMove.dragInfo.indicatorMovePosX+this.columnMove.dragInfo.increasedX),g.length>0&&(d=g.index(),e=this.viewModel.getOption("frozenColumn"),f=e>d?d:d+this.startCol-e,h[this.columnMove.targetIndex]!==i[this.columnMove.targetIndex]&&(this.columnMove.targetIndex=b(h).indexOf(this.columnMove.draggedColumn)),f===this.columnMove.draggedColumn?(this.columnMove.$indicator.addClass("hide"),a("body").addClass("not-allowed"),(c.target.className.indexOf("gGrid-headerLabelWrap")>-1||c.target.className.indexOf("gGrid-headerLabelText")>-1||c.target.className.indexOf("w5-grid-sort")>-1)&&a(c.target).closest("th").addClass("not-allowed").removeClass("allowed")):(this.columnMove.$indicator.removeClass("hide").css({left:g.position().left+(f<this.columnMove.draggedColumn?0:g.outerWidth())-3}),(c.target.className.indexOf("gGrid-headerLabelWrap")>-1||c.target.className.indexOf("gGrid-headerLabelText")>-1||c.target.className.indexOf("w5-grid-sort")>-1)&&a(c.target).closest("th").addClass("allowed").removeClass("not-allowed")))},moveEvent:function(a){this.columnMove.draggedColumn&&this.columnMove._moveEvent.call(this,a)},_upEvent:function(c){var d,e,f,g=a(c).closest("th"),h=this.viewModel.getOption("colOrder"),i=this.viewModel.getVisibleCol();g.length>0&&(d=g.index(),e=this.viewModel.getOption("frozenColumn"),f=e>d?d:d+this.startCol-e,h[f]!==i[f]&&(f=b(h).indexOf(this.columnMove.draggedColumn)),this.columnMove.draggedColumn!==f&&this.moveColumn(this.columnMove.draggedColumn,f)),a("body").removeClass("noselect").removeClass("not-allowed"),g.removeClass("allowed").removeClass("not-allowed"),this.columnMove.$indicator.addClass("hide").removeClass("show"),this.columnMove.$indicatorStart.addClass("hide"),this.columnMove.$indicatorMove.addClass("hide"),this.columnMove.draggedColumn=null},upEvent:function(a){this.columnMove._upEvent.call(this,a.target),document.removeEventListener("mousemove",this.columnMove._wrapMoveEvent,!0),document.removeEventListener("mouseup",this.columnMove._wrapUpEvent,!0)}},frozenColumn:{frozenColumnIdx:null,newFrozenCol:-1,dragInfo:{},_wrapMoveEvent:null,_wrapUpEvent:null,_downEvent:function(a){this.frozenColumn.frozenColumnIdx=this.viewModel.getOption("frozenColumn"),this.frozenColumn.dragInfo={startX:a-this.$wrapper_div.offset().left,endX:0}},downEvent:function(a){var c=this;this.frozenColumn._downEvent.call(this,a.clientX),this.frozenColumn.$frozenHandle=this.$el.find(".frozenHandle"),this.frozenColumn.$seperateCol=this.$el.find(".frozenHandle-move"),this.frozenColumn.$indicator=this.$el.find(".columnMove-indicator"),this.frozenColumn._wrapMoveEvent=function(a){c.frozenColumn.moveEvent.call(this,a)},this.frozenColumn._wrapUpEvent=function(a){c.frozenColumn.upEvent.call(this,a)},this.frozenColumn._wrapMoveEvent=b.bind(this.frozenColumn._wrapMoveEvent,this),this.frozenColumn._wrapUpEvent=b.bind(this.frozenColumn._wrapUpEvent,this),document.addEventListener("mousemove",this.frozenColumn._wrapMoveEvent,!0),document.addEventListener("mouseup",this.frozenColumn._wrapUpEvent,!0)},_moveEvent:function(a){var b,c=-1,d=0,e=0,f=this.viewModel.getVisibleCol(),g=this.frozenColumn.$indicator.width();for(this.frozenColumn.dragInfo.endX=a-this.$wrapper_div.offset().left,this.frozenColumn.$seperateCol.css("left",this.frozenColumn.dragInfo.endX),this.frozenColumn.$seperateCol.removeClass("hide").addClass("show"),this.frozenColumn.newFrozenCol=-1,b=0;b<f.length;b++)if(d=this.viewModel.getMeta(["*",b],"width"),e+=d,-1===this.frozenColumn.newFrozenCol)e-d/2>=this.frozenColumn.dragInfo.endX&&(this.frozenColumn.newFrozenCol=c=b,e=d);else if(c=b,e>this.$wrapper_div.width())break;if(this.frozenColumn.frozenColumnIdx!==this.frozenColumn.newFrozenCol)for(e=0,b=0;b<this.frozenColumn.newFrozenCol;b++)e+=this.viewModel.getMeta(["*",b],"width");this.frozenColumn.$indicator.removeClass("hide").addClass("show").css("left",e-g/2)},moveEvent:function(a){this.frozenColumn._moveEvent.call(this,a.clientX)},_upEvent:function(){this.frozenColumn.$seperateCol.removeClass("show").addClass("hide"),this.frozenColumn.$indicator.removeClass("show").addClass("hide"),this.viewModel.setOption("frozenColumn",this.frozenColumn.newFrozenCol),this.drawByScroll()},upEvent:function(a){this.frozenColumn._upEvent.call(this,a.target),document.removeEventListener("mousemove",this.frozenColumn._wrapMoveEvent,!0),document.removeEventListener("mouseup",this.frozenColumn._wrapUpEvent,!0)}},verticalScroll:{pos:null,_wrapMoveEvent:null,_wrapUpEvent:null,_areaDownEvent:function(b){var c,d=this.rowTop,e=this.viewModel.getOption("vScrollDegree")||this.viewModel.getOption("rowNum");d+=(b<this.$scrollYHandle.position().top?-1:1)*e,c=20*d,this.viewModel.setOption("scrollTop",c),a("body").addClass("noselect")},areaDownEvent:function(a){var b=a.offsetY||a.pageY-this.$scrollYArea.offset().top;this.verticalScroll._areaDownEvent.call(this,b)},_handleDownEvent:function(a){var b=this.$scrollYHandle.position().top;this.verticalScroll.pos={top:b,currentY:a}},handleDownEvent:function(a){var c=this;this.verticalScroll._handleDownEvent.call(this,a.clientY),a.preventDefault(),a.stopPropagation(),this.verticalScroll._wrapMoveEvent=function(a){c.verticalScroll.moveEvent.call(this,a)},this.verticalScroll._wrapUpEvent=function(a){c.verticalScroll.upEvent.call(this,a)},this.verticalScroll._wrapMoveEvent=b.bind(this.verticalScroll._wrapMoveEvent,this),this.verticalScroll._wrapUpEvent=b.bind(this.verticalScroll._wrapUpEvent,this),document.addEventListener("mousemove",this.verticalScroll._wrapMoveEvent,!0),document.addEventListener("mouseup",this.verticalScroll._wrapUpEvent,!0)},_moveEvent:function(a){if(this.verticalScroll.pos){var b=this.$scrollYArea.height()-this.$scrollYHandle.height(),c=parseInt(this.verticalScroll.pos.top+a-this.verticalScroll.pos.currentY,10),d=this.wholeTblHeight-20*this.viewModel.getOption("rowNum"),e=c*d/b;this.viewModel.setOption("scrollTop",e)}},moveEvent:function(a){this.verticalScroll._moveEvent.call(this,a.clientY)},_upEvent:function(){this.verticalScroll.pos=null},upEvent:function(){this.verticalScroll._upEvent.call(this),document.removeEventListener("mousemove",this.verticalScroll._wrapMoveEvent,!0),document.removeEventListener("mouseup",this.verticalScroll._wrapUpEvent,!0)}},horizontalScroll:{pos:null,_wrapMoveEvent:null,_wrapUpEvent:null,_areaDownEvent:function(a){var b=this.$scrollXHandle.position().left,c=this.$scrollXArea.width()-this.$scrollXHandle.width(),d=b*(this.wholeTblWidth-this.tableWidth)/c,e=this.viewModel.getFrozenArea();d+=(b>a?-1:1)*(this.tableWidth-e),this.viewModel.setOption("scrollLeft",d)},areaDownEvent:function(b){var c=b.offsetX||b.pageX-a(b.target).offset().left;this.horizontalScroll._areaDownEvent.call(this,c)},_handleDownEvent:function(a){this.horizontalScroll.pos={left:this.$scrollXHandle.position().left,currentX:a}},handleDownEvent:function(a){var c=this;this.horizontalScroll._handleDownEvent.call(this,a.clientX),a.preventDefault(),a.stopPropagation(),this.horizontalScroll._wrapMoveEvent=function(a){c.horizontalScroll.moveEvent.call(this,a)},this.horizontalScroll._wrapUpEvent=function(a){c.horizontalScroll.upEvent.call(this,a)},this.horizontalScroll._wrapMoveEvent=b.bind(this.horizontalScroll._wrapMoveEvent,this),this.horizontalScroll._wrapUpEvent=b.bind(this.horizontalScroll._wrapUpEvent,this),document.addEventListener("mousemove",this.horizontalScroll._wrapMoveEvent,!0),document.addEventListener("mouseup",this.horizontalScroll._wrapUpEvent,!0)},_moveEvent:function(a){if(this.horizontalScroll.pos){var b=this.$scrollXArea.width()-this.$scrollXHandle.width(),c=parseInt(this.horizontalScroll.pos.left+a-this.horizontalScroll.pos.currentX,10),d=this.wholeTblWidth-this.tableWidth,e=c*d/b;this.viewModel.setOption("scrollLeft",e)}},moveEvent:function(a){this.horizontalScroll._moveEvent.call(this,a.clientX)},_upEvent:function(){this.horizontalScroll.pos=null},upEvent:function(){this.horizontalScroll._upEvent.call(this),document.removeEventListener("mousemove",this.horizontalScroll._wrapMoveEvent,!0),document.removeEventListener("mouseup",this.horizontalScroll._wrapUpEvent,!0)}},scrollByWheel:{wheelEvent:function(a){var b=a.originalEvent||a,c=0,d=0;"detail"in b&&(d=b.detail),"wheelDelta"in b&&(d=-1*b.wheelDelta),"wheelDeltaY"in b&&(d=-1*b.wheelDeltaY),"wheelDeltaX"in b&&(c=-1*b.wheelDeltaX),Math.abs(d)<40?d*=20:d/=2,this.scrollBy(c,d),a.preventDefault(),a.stopPropagation()}},clickCell:{clickEvent:function(b){var c=a(b.target).closest("tr").index()+this.rowTop,d=a(b.target).closest("td").index(),e=this.viewModel.getOption("frozenColumn"),f=e>d?d:d+this.startCol-e,g=this.viewModel.getMeta([c,f],"displayType");this.setFocusedCell(c,f,"TD"===b.target.tagName),q[g][b.type]&&q[g][b.type](b,this,c,f)}},onModelChange:function(a){var c=a.collection.indexOf(a);b.each(a.changed,function(d,e){var f,g,h=this.gridEventMatch.change||[],i={type:"change"};for(f=0;f<h.length;f++){var j=this.select(h[f].select);for(g=0;g<j.length;g++)this.viewModel.getDataCID(j[g][0])===a.cid&&j[g][1]===e&&(b.isString(h[f].funcName)?this.options[h[f].funcName].call(this,i,c,e):b.isFunction(h[f].funcName)&&h[f].funcName.call(this,i,c,e))
}this.drawCell(c,e)},this)},onModelAddRemove:function(a,b,c){var d=b.indexOf(a);-1===d&&(d=c.index||0),this.drawTbody(d)},onReset:function(){this.$wrapper_div&&(this.viewModel.setOption("scrollLeft",0,{silent:!0}),this.viewModel.setOption("scrollTop",0,{silent:!0}),this.setResize())},drawWhole:function(a){a instanceof t&&this.onReset()},drawMetaByPos:function(a){var c,d;if(a.hasChanged("width")||a.hasChanged("flex")||a.hasChanged("hidden"))return void("column"===a.type&&(this.viewModel.updateVisibleCol(),this.setResize()));if(a.hasChanged("closed")&&"row"===a.type&&(d=a.get("id").split(","),d[0]=this.viewModel.getMetaIndex(d[0]),this.viewModel.toggleGroup(d[0])),"table"===a.type)this.drawTbody();else if("row"===a.type||b(a.changed).keys().length>1)d=this.viewModel.getMetaIndex(a.id),this.drawTbody(d,d);else if("column"===a.type)for(d=a.get("id"),c=this.rowTop;c<this.rowTop+this.viewModel.getOption("rowNum");c++)this.drawCell(c,d);else d=a.get("id").split(","),d[0]=this.viewModel.getMetaIndex(d[0]),this.drawCell(d[0],d[1])},drawByScroll:function(){if(this.$el){var c,d,e,f,g,h,i,j,k,l,m,n=this.viewModel.getOption("scrollLeft"),o=this.viewModel.getOption("scrollTop"),p=this.viewModel.getOption("frozenColumn"),q=this.wholeTblWidth-this.tableWidth,r=this.wholeTblHeight-20*this.viewModel.getOption("rowNum"),s=this.$el.find(".frozenHandle"),t=this.$el.find("colgroup col"),u=this.viewModel.getFrozenArea(),v=this.viewModel.getVisibleCol(),w=0,x=-1,y=-1,z=!1;for(n>q&&(n=q),0>n&&(n=0),n=parseInt(n,10),this.viewModel.setOption("scrollLeft",n,{silent:!0}),s.css("left",u).toggleClass("hide",!u).toggleClass("show",!!u),this.$scrollXArea.css("left",u),j=p;j<v.length;j++)if(k=this.viewModel.getMeta(["*",j],"width"),w+=k,-1===x)w-k/2>n&&(x=y=j,w=k);else if(y=j,w>this.$scrollXArea.width())break;if(this.startCol!==x||this.endCol!==y){for(this.startCol=x,this.endCol=y,j=t.length;y-x+p>=j;j++)this.$el.find("colgroup").append("<col>"),this.$el.find("thead tr").append("<th><div class='gGrid-headerLabelWrap'><div class='gGrid-headerLabelText'></th>"),this.$el.find("tbody tr").append("<td>");t=this.$el.find("colgroup col"),this.$el.find("table").width(w+u),b(t).each(function(b,c){var d=p>c?c:c+x-p,e=y>=d?this.viewModel.getMeta(["*",d],"width"):0;a(b).width(e),0===e&&a(this.getHeaderCell(0,c)).children(0).html("")},this),z=!0}o>r&&(o=r),0>o&&(o=0),o=parseInt(o,10),this.viewModel.setOption("scrollTop",o,{silent:!0}),m=parseInt(o/20,10),this.rowTop!==m&&(this.rowTop=m,z=!0),z&&(this.drawHeader(),this.drawTbody(),this.setFocusedCell()),e=this.$scrollYArea.height(),f=this.$el.find("tbody tr").length*e/this.viewModel.getDataLength(),f=this.scrollYHandleMinHeight>f?this.scrollYHandleMinHeight:f,g=this.$scrollXArea.width(),h=g*this.tableWidth/this.wholeTblWidth,h=this.scrollXHandleMinWidth>h?this.scrollXHandleMinWidth:h,c=e-f,l=parseInt(o*c/r+.5,10),this.$scrollYHandle.css("top",l+"px"),this.$scrollYHandle.height(f),this.$scrollYArea.css("opacity",f>=e?0:1),d=g-h,i=d*n/(this.wholeTblWidth-this.tableWidth),this.$scrollXHandle.css("left",i+"px"),this.$scrollXHandle.width(h),this.$scrollXArea.css("opacity",h>=g?0:1)}},onOptionChange:function(a){a.hasChanged("colOrder")&&(this.viewModel.updateVisibleCol(),this.setResize()),a.hasChanged("frozenColumn")&&(this.wholeTblWidth=this.getWholeTblWidth(),this.viewModel.setOption("scrollLeft",0,{silent:!0}),this.drawByScroll()),(a.hasChanged("scrollLeft")||a.hasChanged("scrollTop"))&&this.drawByScroll(),a.hasChanged("width")&&(this.$el.css("width",a.get("option").value.width),this.setResize())},getHeaderCell:function(a,b){return this.$el.find("table thead tr:nth-child("+(a+1)+")").find("th:nth-child("+(b+1)+")")[0]},getTbodyCell:function(a,b){return this.$el.find("table tbody tr:nth-child("+(a+1)+")").find("td:nth-child("+(b+1)+")")[0]},getWholeTblWidth:function(){var a,b,c=0,d=-1,e=this.viewModel.getOption("frozenColumn"),f=this.viewModel.getFrozenArea(),g=this.viewModel.getVisibleCol();for(b=g.length-1;b>=e;b--){if(a=this.viewModel.getMeta(["*",b],"width"),b!==g.length-1&&c+a>this.tableWidth-f){d=b;break}c+=a}for(c=0,b=e;d>=b;b++)c+=this.viewModel.getMeta(["*",b],"width");return c+this.tableWidth},getWholeTblHeight:function(){return 20*this.viewModel.getDataLength()},drawHeader:function(){for(var a=this.viewModel.getOption("frozenColumn"),b=0;a>b;b++)this.drawHeaderCell(0,b);for(b=this.startCol;b<=this.endCol;b++)this.drawHeaderCell(0,b)},drawTbody:function(a,b){var c,d=this.viewModel.getOption("frozenColumn");for(a=a||this.rowTop,arguments.length<2&&(b=this.rowTop+this.viewModel.getOption("rowNum")-1),c=a;b>=c;c++){for(var e=0;d>e;e++)this.drawCell(c,e);for(e=this.startCol;e<=this.endCol;e++)this.drawCell(c,e)}},drawHeaderCell:function(c,d){var e=this.viewModel.getColIndex(d),f=this.viewModel.getOption("colOrder"),g=this.viewModel.getOption("frozenColumn"),h=this.viewModel.getVisibleCol(),i=g>e?e:e-this.startCol+g,j=this.getHeaderCell(0,i),k=this.viewModel.getMeta(["*",d],"headerLabel"),l=a("<div class='gGrid-headerLabelText'></div>"),m=a("<i class='w5-grid-sort'></i>");j&&(l.append(k),this.viewModel.hasMeta(["*",d],"sortable")&&l.append(m),a(j).attr("abbr",k).children(0).html("").append(l).append(this.getColMenu(e)).append(this.getAdjustColHandle(e)));var n=b(f).indexOf(h[d]),o=f[n-1];0===n||b(h).indexOf(o)>=0?a(j).find(".display-left .w5-grid-column-show").addClass("hide"):a(j).find(".display-left .w5-grid-column-show").removeClass("hide");var p=this.collection.sortInfo.column||[],q=this.collection.sortInfo.direction||[],r=["state-none","state-asc","state-desc"],s=["Sort None","Sort Ascending","Sort Descending"],t=this.viewModel.getColID(d),u=b.indexOf(p,t),v=-1===u?0:"asc"===q[u]?1:2;a(j).find(".w5-grid-sort").addClass(r[v]).removeClass(r[(v+1)%3]).removeClass(r[(v+2)%3]).text(s[v])},drawCell:function(c,d){var e,f,g,h,i,j,k,l,m=this.viewModel.getColIndex(d),n=this.viewModel.getOption("frozenColumn"),o=n>m||this.startCol<=m&&m<=this.endCol,p=this.rowTop<=c&&c<this.rowTop+this.viewModel.getOption("rowNum"),r=n>m?m:m-this.startCol+n;o&&p&&(e=a(this.getTbodyCell(c-this.rowTop,r)),e.length>0&&(c<this.viewModel.getDataLength()?(f=this.viewModel.getData([c,d]),g=q[this.viewModel.getMeta([c,d],"displayType")],i=this.viewModel.getMeta([c,d],"nodeFormatter"),i&&b.isFunction(i)&&(j=!0),j&&i.destroy&&b.isFunction(i.destroy)&&i.destroy.call(this.view,e,f,this.viewModel.collection.at(c),c,this.viewModel.getColID(m)),e.html("").append(g.getContent(this,f,c,m)),j&&(h=e.get(0),h=h.querySelector(":first-child"),h&&i.call(this.view,e,h,f,this.viewModel.collection.at(c),c,this.viewModel.getColID(m))),k=this.viewModel.getMeta([c,d],"style"),l=this.viewModel.getMeta([c,d],"class")||""):(e.html(""),k=null,l=""),e[0].style.cssText="",k&&e.css(k),e.attr("class",l)))},getAdjustColHandle:function(){var c=this,d={$adjustHandle:a("<i class='adjustCol-handle'>Adjust this Column</i>"),$adjustCol_start:c.$el.find(".adjustCol-start"),$adjustCol_move:c.$el.find(".adjustCol-move"),targetCol:0,targetColW:0,draggingX:0,colDragInfo:{},downEvent:function(b){var d=c.$wrapper_div.find("thead th").eq(a(b.target).parent().closest("th").index()+1);this.targetCol=a(b.target).parent().closest("th").index(),this.targetColW=a(b.target).parent().closest("th").width(),this.colDragInfo={posX:b.clientX,startX:d.position().left},this.$adjustCol_start.css("left",this.colDragInfo.startX),this.$adjustCol_start.removeClass("hide").addClass("show"),this.$adjustCol_move.css("left",this.colDragInfo.startX),this.$adjustCol_move.removeClass("hide").addClass("show"),document.addEventListener("mousemove",this.moveEvent,!0),document.addEventListener("mouseup",this.upEvent,!0),b.stopPropagation()},moveEvent:function(b){this.draggingX=b.clientX-this.colDragInfo.posX,this.$adjustCol_move.css("left",this.colDragInfo.startX+this.draggingX-this.$adjustCol_move.width()),a("body").addClass("sizingH")},upEvent:function(){var b=c.viewModel.getOption("frozenColumn");this.targetCol>=b&&(this.targetCol+=c.startCol-b);var d=c.viewModel.getMeta(["*",this.targetCol],"width");c.viewModel.removeMeta(["*",this.targetCol],"flex",{silent:!0}),c.viewModel.setMeta(["*",this.targetCol],"width",d+this.draggingX),this.$adjustCol_start.removeClass("show").addClass("hide"),this.$adjustCol_move.removeClass("show").addClass("hide"),a("body").removeClass("sizingH"),document.removeEventListener("mousemove",this.moveEvent,!0),document.removeEventListener("mouseup",this.upEvent,!0)}};return b(d).bindAll("downEvent","moveEvent","upEvent"),d.$adjustHandle.on("mousedown",d.downEvent),d.$adjustHandle},colLeftMenu:b.template("<div class='gGrid-colMenu display-left'><button type='button' class='w5-grid-column-show'>Show hide column</button></div>"),colRightMenu:b.template("<div class='gGrid-colMenu display-right hide'><button type='button' class='w5-grid-colMenu-icon'>Open this column menu</button><ul role='menu' class='w5-dropdown-menu form-none'><li><a href='#' role='menuitem' class='w5-dropdown-menu-label column-hide'>Column Hide</a></li><li><a href='#' role='menuitem' aria-disabled='false' class='w5-dropdown-menu-label frozen-column'>Set Frozen Column</a></li></ul></div>"),getColMenu:function(c){var d=this,e=a(document.createDocumentFragment()),f=a(this.colLeftMenu()),g=a(this.colRightMenu()),h=g.find(".w5-grid-colMenu-icon"),i=d.viewModel.getOption("colOrder"),j=d.viewModel.getVisibleCol(),k=d.viewModel.getOption("frozenColumn"),l=d.viewModel.getOption("scrollLeft"),m={_showCol:function(){var a,e=b(i).indexOf(j[c])-1,f=b(i).indexOf(j[c-1]);if(!(c>=k))throw new Error("Section of the column to a frozen column can not be show. \nFirst, turn off the frozen column.");for(a=e;a>=f&&a>=0;a--)d.viewModel.setMeta(["*",i[a]],"hidden",!1);d.viewModel.updateVisibleCol()},showCol:function(a){this._showCol(a.target)}};b(m).bindAll("showCol"),f.find(".w5-grid-column-show").on("click",m.showCol),e.append(f);var n={_openColMenu:function(b){var c,e=0,f=a(b).closest("th"),h=f.index();for(d.$el.find("thead th .display-right").removeClass("open"),d.$el.find("thead th .display-right .w5-grid-colMenu-icon").removeClass("on"),c=0;h>=c;c++)e+=d.$el.find("thead th").eq(c).width();e>d.$wrapper_div.width()-f.find(".display-right .w5-dropdown-menu").width()&&f.find(".display-right .w5-dropdown-menu").css({left:"auto",right:"0px"}),g.addClass("open"),a(b).addClass("on")},openColMenu:function(a){this._openColMenu(a)},_closeColMenu:function(){g.removeClass("open"),h.removeClass("on")},closeColMenu:function(){this._closeColMenu()},_hideCol:function(){var a=d.viewModel.getVisibleCol().length;if(1===a)throw new Error("W5 Grid is must have a column.");if(!(c>=k))throw new Error("Section of the column to a frozen column can not be hidden.\nFirst, turn off the frozen column.");d.viewModel.setMeta(["*",c],"hidden",!0),d.viewModel.updateVisibleCol()},hideCol:function(a){this._hideCol(a.target),a.preventDefault()},_frozenCol:function(){d.viewModel.setOption("frozenColumn",c+1)},frozenCol:function(a){this._frozenCol(a),a.preventDefault()}};return b(n).bindAll("openColMenu","closeColMenu","hideCol","frozenCol"),g.find(".w5-grid-colMenu-icon").on("click",function(){a(this).hasClass("on")?n.closeColMenu(a(this)):n.openColMenu(a(this))}),g.find(".w5-dropdown-menu li").find(".column-hide").on("click",n.hideCol),g.find(".w5-dropdown-menu li").find(".frozen-column").on("click",n.frozenCol),d.$el.find("thead th").on("mouseenter",function(){a(this).find(".display-right").removeClass("hide")}),d.$el.find("thead th").on("mouseleave",function(){g.removeClass("open").addClass("hide"),n.closeColMenu()}),"hidden"!==this.viewModel.getMeta(["*",c],"colMenu")&&((0!==l||c+1===k)&&(g.find(".frozen-column").attr("aria-disabled",!0).addClass("disabled"),g.find(".frozen-column").off("click",n.frozenCol)),e.append(g)),e},setFlex:function(){var a=this.tableWidth,c=0,d=[],e=0;if(b(this.viewModel.getVisibleCol()).each(function(b,c){if(this.viewModel.hasMeta(["*",c],"flex")){var f=this.viewModel.getMeta(["*",c],"flex");d.push({col:c,flex:f,diff:0}),e+=f}else a-=this.viewModel.getMeta(["*",c],"width")},this),0!==d.length){for(var f=0;f<d.length;f++)d[f].width=parseInt(d[f].flex*a/e,10),c+=d[f].width;for(a-=c,f=0;a>f;f++){for(var g=1/0,h=-1,i=0;i<d.length;i++){var j=d[i].diff+1,k=d[i].width;g>j*(c/k)&&(g=j*(c/k),h=i)}d[h].diff+=1}for(f=0;f<d.length;f++){var l=["*",d[f].col];l.silent=!0,this.viewModel.setMeta(l,"width",d[f].width+d[f].diff,{silent:!0})}}},setResize:function(){this.tableWidth=this.$wrapper_div.width(),this.setFlex(),this.wholeTblWidth=this.getWholeTblWidth(),this.wholeTblHeight=this.getWholeTblHeight(),this.startCol=this.endCol=-1,this.createTbody(),this.drawByScroll()},checkResize:function(){var a=this.$el.width();this.wrapper_width!==a&&(this.wrapper_width=a,this.setResize())},redraw:function(){return this.setResize(),this},scrollTo:function(a,b){return this.viewModel.setOption({scrollLeft:a||0,scrollTop:b||0}),this},scrollBy:function(a,b){return this.viewModel.setOption({scrollLeft:this.viewModel.getOption("scrollLeft")+(a||0),scrollTop:this.viewModel.getOption("scrollTop")+(b||0)}),this},moveColumn:function(a,b){var c=this.viewModel.getOption("colOrder").slice(),d=c.splice(a,1)[0];return c.splice(b,0,d),this.viewModel.setOption("colOrder",c),this},addRow:function(){return this.viewModel.addRow.apply(this.viewModel,arguments),this},removeRow:function(a,b){return this.viewModel.removeRow(a,b),this},reset:function(a){return a=a||[],this.viewModel.model.meta.table.clear({silent:!0}),this.viewModel.model.meta.row.reset([],{silent:!0}),this.viewModel.model.meta.column.reset([],{silent:!0}),this.viewModel.model.meta.cell.reset([],{silent:!0}),b(this.viewModel.colModel).each(function(a,c){b.chain(a).each(function(a,b){"id"!==b&&this.viewModel.setMeta(["*",c],b,a,{inorder:!0,silent:!0})},this)},this),this.viewModel.collection.reset(a),this},sort:function(a,b){return this.viewModel.sort(a,b),this},getRowLength:function(){return this.viewModel.getDataLength()},getColLength:function(){return this.viewModel.getVisibleCol().length},_getColLength:function(){return this.viewModel.getOption("colOrder").length},getCollection:function(){return this.viewModel.collection},setColumnVisible:function(a,c){var d,e={inorder:!0};return b.isNumber(a)&&this.viewModel.setMeta(["*",a],"hidden",!c,e),b.isArray(a)&&(e.silent=!0,d=a.length-1,b(a).each(function(a,b){b===d&&delete e.silent,this.viewModel.setMeta(["*",a],"hidden",!c,e)},this)),this},getColumnVisibility:function(a){var c=this.viewModel.getOption("colOrder"),d=this.viewModel.getVisibleCol();return"hidden"===a?b(c).difference(d):d},_cell:function(a,b){return new g(this,[[a,this.viewModel.getColID(b,!0)]])},_row:function(a){return new g(this,[[a,"*"]])},_col:function(a){return new g(this,[["*",this.viewModel.getColID(a,!0)]])},cell:function(a,b){return new g(this,[[a,this.viewModel.getColID(b)]])},row:function(a){return new g(this,[[a,"*"]])},col:function(a){return new g(this,[["*",this.viewModel.getColID(a)]])},table:function(){return new g(this,[["*","*"]])},option:function(){return this.viewModel.option},fetch:function(a,b){return this.viewModel.fetch(a,b),this},syncData:function(a){return this.viewModel.syncData(a),this},getGridData:function(){return this.viewModel.getGridData()},find:function(a,b,c){c=c||[];var d;return d=this.matchExp.exec(a),b=b||this,!d||"row"!==d[1]&&"column"!==d[1]||(b=b.collection,"removed"===d[2]&&Array.prototype.push.apply(c,b.__removeModels)),c},matchExp:/(cell|row|column):(\S+)/i,getChildren:function(a,b,c){var d,e,f,g,h,i,j={},k=[];for(f=0;f<a.length;f++){if(g=a[f][0],h=a[f][1],"*"===h&&(!b||"*"===g&&"col"===b||"*"!==g&&"cell"===b))for(d=0;d<this.viewModel.colModel.length;d++)i=this.viewModel.getColID(d),j[g+"_"+i]||(j[g+"_"+i]=1,k.push([g,i]));if("*"===g&&(!b||"*"===h&&"row"===b||"*"!==h&&"cell"===b))for(d=0;d<this.collection.length;d++)j[d+"_"+h]||(j[d+"_"+h]=1,k.push([d,h]));if("*"===g&&"*"===h&&(!b||"cell"===b))for(d=0;d<this.collection.length;d++)for(e=0;e<this.viewModel.colModel.length;e++)i=this.viewModel.getColID(e),j[d+"_"+i]||(j[d+"_"+i]=1,k.push([d,i]))}if(c){var l,m=/\[([^=]+)=([^\]]+)\]/g.exec(c),n=m[1],o=m[2],p=[];for(d=0;d<k.length;d++)l="data"===n?this.viewModel.getData(k[d]):this.viewModel.getMeta(k[d],n),String(l)===o&&p.push(k[d]);k=p}return k},select:function(a){var b,c,d=a.match(/[^ ]+/g),e=[["*","*"]];for(c=0;c<d.length;c++){if(!d[c].match(/^[^\[\s]+\[[^\]]+\]|^[^\[\s]+/g)){b=[];break}var f=(d[c].match(/^[^\[]*/g)||[])[0],h=(d[c].match(/\[[^\]]+\]$/g)||[])[0];b=this.getChildren(e,f,h),e=b}return new g(this,b)},addGridEvent:function(a,b){this.options.gridEvents=this.options.gridEvents||{},this.options.gridEvents[a]=b,this.setGridEvents()},removeGridEvent:function(a){this.options.gridEvents=this.options.gridEvents||{},delete this.options.gridEvents[a],this.setGridEvents()},setFocusedCell:function(a,c,d){if(b.isUndefined(d)&&(d=!0),0===arguments.length){if(!this.focusedCell)return void this.$el.find(".w5-grid-focused-cell").addClass("hide");a=this.focusedCell.rowIndex,c=this.focusedCell.colIndex}else this.focusedCell={rowIndex:a,colIndex:c};this.$el.find(".w5-grid-focused-cell").removeClass("hide");var e=a-this.rowTop,f=this.viewModel.getOption("frozenColumn"),g=f>c?c:c-this.startCol+f,h=this.$el.find("tbody tr").eq(e).find("td").eq(g);if(0===h.length||0>e||0>g)return void this.$el.find(".w5-grid-focused-cell").addClass("hide");var i=h.offset().top-this.$wrapper_div.offset().top,j=h.offset().left-this.$wrapper_div.offset().left,k=h.outerWidth(!0),l=h.outerHeight(!0),m=this.$el.find(".border-top").height();this.$el.find(".border-top").css({top:i,left:j,width:k}),this.$el.find(".border-bottom").css({top:i+l-m,left:j,width:k}),this.$el.find(".border-left").css({top:i,left:j,height:l}),this.$el.find(".border-right").css({top:i,left:j+k-m,height:l}),d&&this.$editBox.focus()},handleKeydown:function(a){this.keydownEvents[a.keyCode]&&this[this.keydownEvents[a.keyCode]].call(this,a)},moveUp:function(a,b){var c,d,e,f=b&&b.isForced;this.focusedCell&&(f||this.checkEditBox(a.target.className,!0))&&(c=this.focusedCell.rowIndex,d=this.focusedCell.colIndex,c>0&&(e=this.rowTop+1,e>c?(this.focusedCell={rowIndex:c-1,colIndex:d},this.viewModel.setOption("scrollTop",20*(c-1))):this.setFocusedCell(c-1,d)))},moveDown:function(a,b){var c,d,e,f,g=b&&b.isForced;this.focusedCell&&(g||this.checkEditBox(a.target.className,!0))&&(c=this.focusedCell.rowIndex,d=this.focusedCell.colIndex,c<this.getRowLength()-1&&(e=this.rowTop+1,f=this.viewModel.getOption("rowNum"),c+3>e+f?(this.focusedCell={rowIndex:c+1,colIndex:d},this.viewModel.setOption("scrollTop",20*(c+1))):this.setFocusedCell(c+1,d)))},moveLeft:function(a,c){var d,e,f,g=c&&c.targetCol,h=c&&c.isForced,i=this.viewModel.getOption("frozenColumn"),j=0;if(this.focusedCell&&(h||this.checkEditBox(a.target.className,!0))&&(d=this.focusedCell.rowIndex,e=this.focusedCell.colIndex,b.isNumber(g)||(g=e-1),g>=0))if(g<this.startCol)if(i>g)this.setFocusedCell(d,g);else{for(this.focusedCell={rowIndex:d,colIndex:g},f=e;f>g-1;f--)j+=this.viewModel.getMeta(["*",f],"width");this.viewModel.setOption("scrollLeft",this.viewModel.getOption("scrollLeft")-j)}else this.setFocusedCell(d,g)},moveRight:function(a,c){var d,e,f,g=c&&c.targetCol,h=c&&c.isForced,i=this.viewModel.getOption("frozenColumn"),j=0;if(this.focusedCell&&(h||this.checkEditBox(a.target.className,!0))&&(d=this.focusedCell.rowIndex,e=this.focusedCell.colIndex,b.isNumber(g)||(g=e+1),g<=this.getColLength()-1))if(g>this.endCol-1)if(this.focusedCell={rowIndex:d,colIndex:g},this.endCol===this.getColLength()-1)this.setFocusedCell(d,g);else{for(f=this.endCol;g+2>f;f++)j+=this.viewModel.getMeta(["*",f],"width");this.viewModel.setOption("scrollLeft",this.viewModel.getOption("scrollLeft")+j)}else i&&i===g&&this.viewModel.setOption("scrollLeft",0),this.setFocusedCell(d,g)},checkEditBox:function(a,b){var c=!1;return"w5_grid_editbox"===a&&(b?this.$editBox.data("edit")||(c=!0):c=!0),c},focusWidget:function(b,c){var d,e,f,g;if(c=c||{},this.focusedCell){var h=this.focusedCell.rowIndex,i=this.focusedCell.colIndex,j=this;d=this.viewModel.getMeta([h,i],"displayType"),g=this.viewModel.getMeta([h,i],"readOnly"),c&&!c.isSkip&&"text"===d?this.$editBox.data("edit")?q.text.endEdit.call(q.text,b,j,{isForced:!0}):g||q.text.popupEditBox.call(q.text,j,h,i):g||(e=this.getTbodyCell(h-this.rowTop,i-this.startCol),e&&(f=this.viewModel.getMeta([h,i],"focusSelector"),"custom"===d&&f?a(e).find(f)[0].focus():(e.firstElementChild||e.children[0]).focus())),b.preventDefault()}},blurWidget:function(a){var b,c,d,e=this;this.focusedCell&&(b=this.focusedCell.rowIndex,c=this.focusedCell.colIndex,d=this.viewModel.getMeta([b,c],"displayType"),"text"===d&&q.text.endEdit.call(q.text,a,e,{isForced:!0}),this.setFocusedCell(b,c))},checkTabbableItem:function(a){return b.contains(this.tabbableElements,a.type)},getActivatePosition:function(c){var d,e,f,g,h=document.activeElement,i=!1,j=null,k=null;return this.checkEditBox(h.className)?this.focusedCell&&(j=this.focusedCell.colIndex,k=this.focusedCell.rowIndex):(d=a(h).closest("tr.gGrid-row>td"),this.checkTabbableItem(h)&&(g=[],f=d.get(0).childNodes,f=b.reduce(f,function(a,b){return"INPUT"===b.tagName&&a.push(b),a},g),c?f[0]!==h&&(i=!0):f[f.length-1]!==h&&(i=!0)),i||(e=d.closest("tr"),j=d.get(0).cellIndex+this.startCol,k=e.get(0).rowIndex-this.headNum+this.rowTop)),{row:k,col:j,runNative:i}},moveActionableItem:function(a){var b,c=a.shiftKey,d=this.getActivatePosition(c),e=this.viewModel.getOption("frozenColumn"),f=this,g=!0;if(!d.runNative&&null!==d.row){if(b=this.viewModel.getMeta([d.row,d.col],"displayType"),"text"===b&&this.$editBox.data("edit")&&q.text.endEdit.call(q.text,a,f,{isForced:!0}),c)if(0===d.col){if(!(d.row>0))return a.preventDefault(),!1;d.row-=1,d.col=this.viewModel.getVisibleCol().length-1,d.col>=this.endCol&&(g=!1,this.moveRight(a,{targetCol:d.col,isForced:!0}),this.moveUp(a,{isForced:!0}))}else d.col-=1,d.col<this.startCol&&(g=!1,this.moveLeft(a,{isForced:!0}));else if(d.col===this.viewModel.getVisibleCol().length-1){if(!(d.row<this.getRowLength()-1))return a.preventDefault(),!1;d.row+=1,d.col=0,d.col<=this.startCol&&(g=!1,this.moveLeft(a,{targetCol:d.col,isForced:!0}),this.moveDown(a,{isForced:!0}))}else d.col+=1,(d.col>this.endCol-1||d.col===e)&&(g=!1,this.moveRight(a,{isForced:!0}));g&&this.setFocusedCell(d.row,d.col,!1),this.focusWidget(a)}},jumpTo:function(a){this.blurWidget(a),36===a.keyCode?this.moveLeft(a,{targetCol:0,isForced:!0}):35===a.keyCode?this.moveRight(a,{targetCol:this.viewModel.getVisibleCol().length-1,isForced:!0}):33===a.keyCode?(this.focusedCell.rowIndex=1,this.moveUp(a,{isForced:!0})):34===a.keyCode&&(this.focusedCell.rowIndex=this.getRowLength()-2,this.moveDown(a,{isForced:!0}))}};g.fn=g.prototype={constructor:g,init:function(a,b){this.grid=a,this.viewModel=a.viewModel,this.push.apply(this,b)},clone:function(a){this.grid=a},length:0,push:[].push,slice:[].slice,splice:[].splice,sort:[].sort},g.fn.init.prototype=g.fn,g.fn.clone.prototype=g.fn;var o={get:function(a){var c=[].slice.call(arguments,1);if("data"===a)return this.viewModel.getData.apply(this.viewModel,[this[0]].concat(c));if("option"===a)return this.viewModel.getOption.apply(this.viewModel,c);var d,e=b.isString(c[0]);return d=this.viewModel.getMeta.apply(this.viewModel,[this[0],a,e?c[1]:c[0]]),e&&(d=d[arguments[1]]),d},set:function(a){var c=[].slice.call(arguments,1);return b(this).each(function(d){if("data"===a)this.viewModel.setData.apply(this.viewModel,[d].concat(c));else if("option"===a)this.viewModel.setOption.apply(this.viewModel,c);else{var e,f=b.isString(c[1]);f?(e=b.clone(this.viewModel.getMeta(d,a,{noncomputed:!0}))||{},e[c[0]]=c[1],this.viewModel.setMeta.apply(this.viewModel,[d,a,e,c[2]])):this.viewModel.setMeta.apply(this.viewModel,[d,a,c[0],c[1]])}},this),this},alter:function(a,c,d){var e=arguments;return b(this).each(function(f){if("data"===a)this.viewModel._setData.apply(this.bobj,[f].concat([].slice.call(e,1)));else if(2===e.length)this.viewModel.setMeta(f,a,c,{alter:!0});else{var g=b.clone(this.viewModel.getMeta(f,a))||{};g[c]=d,this.viewModel.setMeta(f,a,g,{alter:!0})}},this),this},has:function(a,b){if(1===arguments.length)return this.viewModel.hasMeta(this[0],a);var c=this.viewModel.getMeta(this[0],a)||{};return c.hasOwnProperty(b)},unset:function(a,c){var d=arguments;return b(this).each(function(e){if(2===d.length)this.viewModel.removeMeta(e,a);else{var f=b.clone(this.viewModel.getMeta(e,a))||{};delete f[c],this.viewModel.setMeta(e,a,f)}},this),this},addClass:function(a){var b=this.viewModel.getMeta(this[0],"class",{noncomputed:!0});return 0===b.length?this.viewModel.setMeta(this[0],"class",a):this.viewModel.setMeta(this[0],"class",b+" "+a),this},hasClass:function(a){var c=this.viewModel.getMeta(this[0],"class",{noncomputed:!0}),d=!1;return b(c.split(/\s+/)).each(function(b){b===a&&(d=!0)}),d},removeClass:function(a){var c=this.viewModel.getMeta(this[0],"class",{noncomputed:!0});return 0!==c.length&&this.viewModel.setMeta(this[0],"class",b(c.split(/\s+/)).difference(a.split(/\s+/)).join(" ")),this},toggleClass:function(a,c){var d,e=this.viewModel.getMeta(this[0],"class",{noncomputed:!0});return 1===arguments.length&&(b(e.split(/\s+/)).each(function(b,c){b===a&&(d=c)}),c=b.isUndefined(d)?!0:!1),c?this.addClass(a):this.removeClass(a),this}},p={alterValue:function(a,b,c){b.firstChild.value=c}},q={};q.text=b.defaults({getContent:function(a,c,d,f){var g=a.viewModel.getMeta([d,f],"template")||"<%=data%>",h=a.viewModel.getMeta([d,f],"format")||"",i=a.viewModel.getMeta([d,f],"originalFormat")||"",j=a.viewModel.getOption("dayInWeek")||e.formatter.defaultDayInWeek;return b.isString(g)&&(g=b.template(g)),g({data:b.isFunction(h)?h.call(a,c):e.formatter(c,h,{originalFormat:i,dayInWeek:j})})},dblclick:function(b,c,d,e){var f=c.viewModel.getMeta([d,e],"readOnly");f||this.popupEditBox(c,d,e),a("body").addClass("noselect")},popupEditBox:function(c,e,f){var g=c.viewModel.getOption("frozenColumn"),h=g>f?f:f-c.startCol+g,i=a(c.getTbodyCell(e-c.rowTop,h)),j=c.viewModel.getData([e,f]);if(c.$editBox.text(j).css({width:"auto","min-width":i.outerWidth(),height:i.outerHeight(),top:i.offset().top-c.$wrapper_div.offset().top,left:i.offset().left-c.$wrapper_div.offset().left}).data({edit:!0,row:e,col:f,grid:c,dataType:b.isNumber(j)?"number":b.isBoolean(j)?"boolean":null}),c.$editBox.focus(),"undefined"!=typeof d.getSelection&&"undefined"!=typeof document.createRange){var k=document.createRange();k.selectNodeContents(c.$editBox[0]),k.collapse(!1);var l=d.getSelection();l.removeAllRanges(),l.addRange(k)}else if("undefined"!=typeof document.body.createTextRange){var m=document.body.createTextRange();m.moveToElementText(c.$editBox[0]),m.collapse(!1),m.select()}},endEdit:function(b,c,d){if(("blur"===b.type||"keydown"===b.type&&13===b.keyCode||d.isForced)&&c.$editBox.data("edit")){var f=c.$editBox.text(),g=c.$editBox.data("row"),h=c.$editBox.data("col"),i=c.$editBox.data("dataType");c.viewModel.setData([g,h],i?e.dataType[i](f):f),c.$editBox.text("").css("cssText",""),c.$editBox.removeData("edit")}a("body").removeClass("noselect")}},p),b(q.text).bindAll("dblclick","popupEditBox","endEdit"),q.select=b.defaults({getContent:function(c,d,e,f){var g,h,i=c.viewModel.getMeta([e,f],"options"),j=c.viewModel.getMeta([e,f],"callback");for(g=a("<select>"+b(i).reduce(function(a,b){return a+"<option>"+b.label+"</option>"},"")+"</select>"),h=0;h<i.length;h++)if(i[h].value===d){g.val(i[h].label);break}return g.data("pos",{row:e,col:f}),g.on("change",function(){var d=a(this),e=d.data("pos"),f=d.val(),g=c.viewModel.getMeta([e.row,e.col],"options"),h=b(g).findWhere({label:f}).value;c.viewModel.setData([e.row,e.col],h,{silent:!0}),j&&j.change&&b.isFunction(j.change)&&j.change.call(c,h,e)}),g},dblclick:function(a,b){b.focusWidget(a,{isSkip:!0})}},p),q.checkbox=b.defaults({getContent:function(c,d,e,f){var g=c.viewModel.getMeta([e,f],"options"),h=c.viewModel.getMeta([e,f],"callback"),i=d.split(" "),j=a(b(g).reduce(function(a,c,d){var g=b(i).indexOf(c.value)>=0?" checked='true'":"";return a+"<input type='checkbox' id='checkbox_"+e+"_"+f+"_"+d+"'"+g+"><label for='checkbox_"+e+"_"+f+"_"+d+"'>"+c.label+"</label>"},""));return j.data("pos",{row:e,col:f}),j.on("change",function(){var d=a(this),e=d.parent().find("input[type=checkbox]"),f=d.data("pos"),g=c.viewModel.getMeta([f.row,f.col],"options"),i=e.map(function(b,c){return a(c).prop("checked")}),j=b.chain(g).map(function(a,b){return i[b]?a.value:""}).compact().value().join(" ");c.viewModel.setData([f.row,f.col],j,{silent:!0}),h&&h.change&&b.isFunction(h.change)&&h.change.call(c,j,f)}),j},dblclick:function(a,b){b.focusWidget(a,{isSkip:!0})}},p),q.radio=b.defaults({getContent:function(c,d,e,f){var g=c.viewModel.getMeta([e,f],"options"),h=c.viewModel.getMeta([e,f],"callback"),i=d.split(" "),j=c.viewModel.getDataCID(e),k=a(b(g).reduce(function(a,c,d){var g=b(i).indexOf(c.value)>=0?" checked='true'":"";return a+"<input type='radio' name='"+j+"' id='radio_"+e+"_"+f+"_"+d+"'"+g+"><label for='radio_"+e+"_"+f+"_"+d+"'>"+c.label+"</label>"},""));return k.data("pos",{row:e,col:f}),k.on("change",function(){var d=a(this),e=d.parent().find("input[type=radio]"),f=d.data("pos"),g=c.viewModel.getMeta([f.row,f.col],"options"),i=e.map(function(b,c){return a(c).prop("checked")}),j=g[b.indexOf(i,!0)],k=j?j.value:void 0;c.viewModel.setData([f.row,f.col],k,{silent:!0}),h&&h.change&&b.isFunction(h.change)&&h.change.call(c,k,f)}),k},dblclick:function(a,b){b.focusWidget(a,{isSkip:!0})}},p),q.link=b.defaults({getContent:function(c,d){var e=b.isObject(d)?d.href:d,f=b.isObject(d)?d.label:d;return a("<a href='"+e+"'>"+f+"</a>")},dblclick:function(a,b){b.focusWidget(a,{isSkip:!0})}},p),q.img=b.defaults({getContent:function(b,c){return a("<img src='"+c+"' tabindex=0 />")}},p),q.button=b.defaults({getContent:function(b,c){return a("<button>"+c+"</button>")},dblclick:function(a,b){b.focusWidget(a,{isSkip:!0})}},p),q.toggleButton=b.defaults({click:function(a,b,c){var d=!!b.viewModel.getMeta([c,"*"],"closed");b.viewModel.setMeta([c,"*"],"closed",!d)},getContent:function(b,c,d){var e=!!b.viewModel.getMeta([d,"*"],"closed"),f=e?"fold":"unfold";return c=c||b.viewModel.getMeta([d,"*"],"group").join("-"),a("<i class='w5-grid-group "+f+"'>"+f+"</i><span class='w5-grid-group-text'>"+c+"</span>")}},p),q.custom=b.defaults({getContent:function(a,c,d,e){var f=a.viewModel.getMeta([d,e],"template")||"<%=data%>",g=a.viewModel.getMeta([d,e],"format")||"";return b.isString(f)&&(f=b.template(f)),f({data:b.isFunction(g)?g.call(this,c):c})},dblclick:function(a,b){b.focusWidget(a,{isSkip:!0})}},p),b(g.fn).extend(o);var r=c.View.extend(n),s=c.Model.extend(b.extend({},j,l)),t=c.Collection.extend(b.extend({model:s},k,m));return e.Model=s,e.Collection=t,e.Grid=r,e.dataType={auto:function(a){return a},string:String,number:Number,"boolean":Boolean},e.formatter=function(a){return a},e});